<!doctype html>
<html>
<head>
    <title>Glyphs</title>
    <script src="chart.js/Chart.js"></script>
</head>
<body>

<div id="area1"><p>Glyph area1:</p></div>
<div id="area2"><p>Glyph area2:</p></div>
<div id="other"><p>Other glyphs</p></div>

<script>
var sample_data = [
    {
        "delta":"194",
        "scheduled":"1980-01-01  17:10:00",
        "population":"5"
    },
    {
        "delta":"254",
        "scheduled":"1980-01-01  17:14:00",
        "population":"0"
    },
    {
        "delta":"76",
        "scheduled":"1980-01-01  17:22:00",
        "population":"2"
    },
    {
        "delta":"2",
        "scheduled":"1980-01-01  17:25:00",
        "population":"1"
    },
    {
        "delta":"-160",
        "scheduled":"1980-01-01  17:30:00",
        "population":"0"
    },
    {
        "delta":"-764",
        "scheduled":"1980-01-01  17:55:00",
        "population":"0"
    },
    {
        "delta":"-764",
        "scheduled":"1980-01-01  17:57:00",
        "population":"12"
    },
    {
        "delta":"-756",
        "scheduled":"1980-01-01  17:58:00",
        "population":"5"
    },
    {
        "delta":"-720",
        "scheduled":"1980-01-01  18:01:00",
        "population":"2"
    },
    {
        "delta":"-714",
        "scheduled":"1980-01-01  18:02:00",
        "population":"1"
    },
    {
        "delta":"-640",
        "scheduled":"1980-01-01  18:03:00",
        "population":"1"
    },
    {
        "delta":"-499",
        "scheduled":"1980-01-01  18:05:00",
        "population":"1"
    },
];

var bar_chart_options = {scaleOverride: true, scaleStartValue: 0,
                         scaleStepWidth: 1, scaleSteps: 15};

// helper function to insert chart in <div id="glyphs" />
function insert_chart(chart_data, type, width, height, target_id) {
    // create canvas element
    var canv = document.createElement('canvas');
    canv.id = Math.random().toString(36).slice(2);
    canv.height = height;
    canv.width = width;
    document.getElementById(target_id).appendChild(canv); 
    
    // add chart
    var ctx = canv.getContext("2d");
    switch (type) {
    case "bar":
        new Chart(ctx).Bar(chart_data, bar_chart_options);
        break;
    
    default:
        throw "Invalid chart type"
    }
    return canv.id;
}
                     
// Create a new bar chart displaying each stop individually.
// Chart will be placed in the HTML element with id=target_id
// Returns the chart's unique id
// 
// NOTE: data will be displayed *in the order* given by raw_data
function individual_bar_all(raw_data, width, height, target_id) {
    var chart_data = {labels: [], datasets: [ {data: [], fillColor: "rgba(0,127,0,.8)"},
                                              {data: [], fillColor: "rgba(0,0,0,.8" },
                                              {data: [], fillColor: "rgba(127,0,0,.8"} ]};
    
    // format data
    raw_data.forEach(function(val) {
        var time_string = (new Date(Date.parse( val.scheduled ))).toTimeString().slice(0,5)
        chart_data.labels.push( time_string );
        
        var delta = parseInt(val.delta) / 60.0;
        if (delta < 0) {
            chart_data.datasets[0].data.push(-delta);
            chart_data.datasets[2].data.push(0);
        } else {
            chart_data.datasets[0].data.push(0);
            chart_data.datasets[2].data.push(delta);
        }
        
        chart_data.datasets[1].data.push(val.population);
    } );
    
    return insert_chart(chart_data, "bar", width, height, target_id);
}

// Like individual_bar_all(), but population only
function individual_bar_adhere(raw_data, width, height, target_id) {
    var chart_data = {labels: [], datasets: [ {data: [], fillColor: "rgba(0,127,0,.8" },
                                              {data: [], fillColor: "rgba(127,0,0,.8" } ]};
    
    // format data
    raw_data.forEach(function(val) {
        var time_string = (new Date(Date.parse( val.scheduled ))).toTimeString().slice(0,5)
        chart_data.labels.push( time_string );
        
        var delta = parseInt(val.delta) / 60.0;
        if (delta < 0) {
            chart_data.datasets[0].data.push(-delta);
            chart_data.datasets[1].data.push(0);
        } else {
            chart_data.datasets[0].data.push(0);
            chart_data.datasets[1].data.push(delta);
        }
    } );
    
    return insert_chart(chart_data, "bar", width, height, target_id);
}

// Like individual_bar_all(), but adherence only
function individual_bar_pop(raw_data, width, height, target_id) {
    var chart_data = {labels: [], datasets: [ {data: [], fillColor: "rgba(0,0,0,.8" } ]};
    
    // format data
    raw_data.forEach(function(val) {
        var time_string = (new Date(Date.parse( val.scheduled ))).toTimeString().slice(0,5)
        chart_data.labels.push( time_string );
        
        chart_data.datasets[0].data.push(val.population);
    } );
    
    return insert_chart(chart_data, "bar", width, height, target_id);
}

individual_bar_all(sample_data, 480, 320, "area1");
individual_bar_pop(sample_data, 480, 320, "area2");
individual_bar_adhere(sample_data, 480, 320, "other");

</script>

</body>
</html>